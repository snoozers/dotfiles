#!/bin/bash

set -e

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Vim セットアップスクリプト
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

DOTFILES_DIR="${ZDOTDIR:-$HOME}/dotfiles"
VUNDLE_DIR="$HOME/.vim/bundle/Vundle.vim"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📝 Vim セットアップ"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 1. Vundle (プラグインマネージャ) のインストール
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

if [[ -d "$VUNDLE_DIR" ]]; then
    echo "✅ Vundle は既にインストールされています: $VUNDLE_DIR"
else
    echo "📦 Vundle をインストール中..."
    git clone https://github.com/VundleVim/Vundle.vim.git "$VUNDLE_DIR"
    echo "✅ Vundle のインストール完了"
fi

echo ""

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 2. .vimrc のシンボリックリンク作成
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

if [[ -f "$HOME/.vimrc" ]] && [[ ! -L "$HOME/.vimrc" ]]; then
    echo "📋 既存の .vimrc をバックアップ: ~/.vimrc.backup.$(date +%Y%m%d%H%M%S)"
    mv "$HOME/.vimrc" "$HOME/.vimrc.backup.$(date +%Y%m%d%H%M%S)"
fi

if [[ -L "$HOME/.vimrc" ]]; then
    echo "✅ .vimrc のシンボリックリンクは既に存在します"
else
    echo "🔗 .vimrc のシンボリックリンクを作成中..."
    ln -snfv "$DOTFILES_DIR/.vimrc" "$HOME/.vimrc"
    echo "✅ シンボリックリンクの作成完了"
fi

echo ""

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 3. Vim プラグインのインストール
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo "📦 Vim プラグインをインストール中..."
echo "   （Vimが起動してプラグインをインストールします）"
echo ""

# Vimを起動してプラグインをインストール
vim +PluginInstall +qall 2>/dev/null || true

echo ""
echo "✅ Vim プラグインのインストール完了"

echo ""

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 4. 完了メッセージ
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✨ Vim セットアップ完了！"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "💡 ヒント："
echo "  - プラグインの追加: .vimrc を編集 → vim +PluginInstall +qall"
echo "  - プラグインの更新: vim +PluginUpdate +qall"
echo "  - プラグインの削除: .vimrc から削除 → vim +PluginClean +qall"
echo ""
