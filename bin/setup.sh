#!/bin/zsh

set -e

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# dotfiles 統合セットアップスクリプト
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

DOTFILES_DIR="${ZDOTDIR:-$HOME}/dotfiles"
SCRIPT_DIR="$DOTFILES_DIR/bin"

# スクリプトのディレクトリに移動
cd "$DOTFILES_DIR"

echo "╔════════════════════════════════════════════════════════════════╗"
echo "║                                                                ║"
echo "║              🚀 dotfiles セットアップ開始 🚀                  ║"
echo "║                                                                ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""
echo "このスクリプトは以下をセットアップします："
echo "  1. Zsh環境（Oh My Zsh + Powerlevel10k + プラグイン）"
echo "  2. 外部ツール（fzf + ripgrep）"
echo "  3. Vim環境（Vundle + プラグイン）"
echo "  4. dotfiles設定ファイルのシンボリックリンク"
echo ""

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 確認プロンプト
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

read -q "REPLY?続行しますか？ (y/N): "
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "❌ セットアップをキャンセルしました"
    exit 0
fi

echo ""

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Step 1: Zsh環境のセットアップ
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo ""
echo "┌────────────────────────────────────────────────────────────────┐"
echo "│ Step 1/3: Zsh環境のセットアップ                               │"
echo "└────────────────────────────────────────────────────────────────┘"
echo ""

if [[ -f "$SCRIPT_DIR/setup_zsh.sh" ]]; then
    zsh "$SCRIPT_DIR/setup_zsh.sh"
else
    echo "❌ エラー: setup_zsh.sh が見つかりません"
    exit 1
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Step 2: 外部ツールのインストール
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo ""
echo "┌────────────────────────────────────────────────────────────────┐"
echo "│ Step 2/3: 外部ツールのインストール                            │"
echo "└────────────────────────────────────────────────────────────────┘"
echo ""

if [[ -f "$SCRIPT_DIR/setup_tools.sh" ]]; then
    zsh "$SCRIPT_DIR/setup_tools.sh"
else
    echo "❌ エラー: setup_tools.sh が見つかりません"
    exit 1
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Step 3: Vim環境のセットアップ
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo ""
echo "┌────────────────────────────────────────────────────────────────┐"
echo "│ Step 3/3: Vim環境のセットアップ                               │"
echo "└────────────────────────────────────────────────────────────────┘"
echo ""

if [[ -f "$SCRIPT_DIR/setup_vim.sh" ]]; then
    zsh "$SCRIPT_DIR/setup_vim.sh"
else
    echo "❌ エラー: setup_vim.sh が見つかりません"
    exit 1
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 完了メッセージ
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

echo ""
echo "╔════════════════════════════════════════════════════════════════╗"
echo "║                                                                ║"
echo "║              ✨ セットアップ完了！ ✨                         ║"
echo "║                                                                ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📝 次のステップ"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "1. シェルを再起動してください："
echo "   $ exec zsh"
echo ""
echo "2. （推奨）フォントをインストールしてください："
echo "   Powerlevel10kを正しく表示するためにNerd Fontが必要です。"
echo ""
echo "   macOSの場合："
echo "   $ brew tap homebrew/cask-fonts"
echo "   $ brew install font-meslo-lg-nerd-font"
echo ""
echo "   その後、ターミナルアプリの設定でフォントを変更："
echo "   - iTerm2: Preferences > Profiles > Text > Font"
echo "   - Terminal.app: Preferences > Profiles > Font"
echo "   - フォント名: MesloLGS NF"
echo ""
echo "3. （オプション）Powerlevel10kの設定ウィザードを実行："
echo "   $ p10k configure"
echo ""
echo "4. （オプション）マシン固有の設定を追加："
echo "   $ vim ~/.zshrc_local"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "💡 便利なコマンド"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "  omz update              # Oh My Zsh の更新"
echo "  p10k configure          # Powerlevel10k の設定変更"
echo "  vim +PluginUpdate +qall # Vim プラグインの更新"
echo ""
